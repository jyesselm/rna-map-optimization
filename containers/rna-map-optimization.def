Bootstrap: docker
From: continuumio/miniconda3:latest

%files
    # Copy environment file and optimization scripts
    environment.yml /opt/environment.yml
    scripts/ /opt/scripts/

%environment
    # Add conda environment bin to PATH so bowtie2, python, and other tools are available
    export PATH=/opt/conda/envs/rna-map-optimization/bin:/opt/conda/bin:$PATH
    export CONDA_DEFAULT_ENV=rna-map-optimization

%post
    # Install system dependencies
    apt-get update && apt-get install -y \
        build-essential \
        wget \
        curl \
        git \
        && rm -rf /var/lib/apt/lists/*

    # Configure git to allow cloning into /tmp (fixes "dubious ownership" error)
    # This is needed for pip to clone rna-map-mini from GitHub
    git config --global --add safe.directory '*'

    # Create conda environment from environment.yml
    # rna-map-mini will be installed automatically via pip from environment.yml
    /opt/conda/bin/conda env create -f /opt/environment.yml -n rna-map-optimization

    # Clean up conda cache
    /opt/conda/bin/conda clean -afy

    # Create directories for data and results
    mkdir -p /data /results /work
    
    # Make optimization scripts executable
    chmod +x /opt/scripts/*.sh /opt/scripts/*.py 2>/dev/null || true

%runscript
    # Default: run Python with conda environment activated
    exec /opt/conda/envs/rna-map-optimization/bin/python "$@"

%labels
    Author RNA MAP Team
    Version 1.0.0
    Description RNA MAP optimization container with Bowtie2, Optuna, and rna-map-mini package

%help
    RNA MAP Optimization Container
    
    This container includes:
    - Python 3.10+ with conda
    - Bowtie2 aligner
    - Optuna for Bayesian optimization
    - rna-map-mini package installed from GitHub
    
    Usage:
        apptainer exec rna-map-optimization.sif python script.py
    
    Or activate the environment:
        apptainer exec rna-map-optimization.sif bash
        conda activate rna-map-optimization
        python script.py
    
    Mount data directories:
        apptainer exec -B /path/to/data:/data -B /path/to/results:/results \
            rna-map-optimization.sif python script.py
    
    Verify installation:
        apptainer exec rna-map-optimization.sif python -c "import rna_map_mini; print('✓ rna-map-mini installed')"
        apptainer exec rna-map-optimization.sif python -c "import optuna; print('✓ optuna installed')"
        apptainer exec rna-map-optimization.sif bowtie2 --version
